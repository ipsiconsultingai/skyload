# 소셜 로그인

> 한 줄 요약: Google/Kakao OAuth를 통한 소셜 로그인 및 세션 관리 구현

## 개요

### 배경

- 회원가입 허들을 낮추기 위해 소셜 로그인 제공 필요
- 자체 인증 시스템 구축 대비 보안성 및 개발 효율성 확보
- 기존 OAuth 클라이언트 모듈(libs/services/oauth) 활용

### 목표

- Google, Kakao 소셜 로그인 지원
- 안전한 세션 관리 (HttpOnly 쿠키 기반)
- 로그인/로그아웃 UI 및 API 구현

## 사용자 시나리오

### 시나리오 1: 소셜 로그인

```
1. 사용자가 로그인 페이지에서 "Google로 로그인" 버튼 클릭
2. Google OAuth 인증 페이지로 리다이렉트
3. 사용자가 Google 계정으로 인증 완료
4. 콜백으로 돌아와 세션 생성 후 메인 페이지로 이동
```

### 시나리오 2: 로그아웃

```
1. 사용자가 "로그아웃" 버튼 클릭
2. 세션 쿠키 삭제 후 로그인 페이지로 이동
```

### 시나리오 3: 인증 필요 페이지 접근

```
1. 비로그인 사용자가 보호된 페이지 접근
2. 로그인 페이지로 리다이렉트
3. 로그인 완료 후 원래 페이지로 이동
```

## 요구사항

### 기능 요구사항

우선순위: 🔴 필수 | 🟡 권장 | 🟢 선택

- [ ] 🔴 Google OAuth 로그인
- [ ] 🔴 Kakao OAuth 로그인
- [ ] 🔴 로그인 페이지 UI (/login)
- [ ] 🔴 OAuth 콜백 처리 API
- [ ] 🔴 세션 생성 및 쿠키 설정 (HttpOnly, Secure, SameSite)
- [ ] 🔴 로그아웃 API
- [ ] 🔴 현재 사용자 조회 API
- [ ] 🟡 인증 상태 전역 관리 (Context)
- [ ] 🟡 미들웨어 기반 라우트 보호
- [ ] 🟡 로그인 후 원래 페이지로 리다이렉트 (returnUrl)
- [ ] 🟢 세션 자동 갱신

### 비기능 요구사항

- **보안**: HttpOnly 쿠키, CSRF 방지 (state 파라미터), Secure 플래그
- **성능**: 세션 조회 200ms 이내

## 구현 가이드

### 구현 위치

```
app/
├── login/page.tsx                      # 로그인 페이지
└── api/auth/
    ├── login/[provider]/route.ts       # OAuth 시작
    ├── callback/[provider]/route.ts    # OAuth 콜백
    ├── logout/route.ts                 # 로그아웃
    └── me/route.ts                     # 현재 사용자

libs/auth/                              # 세션 관리 모듈
middleware.ts                           # 라우트 보호
```

### 기존 코드 활용

| 모듈                  | 용도             | 참고                   |
| --------------------- | ---------------- | ---------------------- |
| `libs/services/oauth` | OAuth 클라이언트 | createOAuthClient 사용 |
| `libs/logger`         | 로깅             | 에러 로깅              |

### 신규 의존성

```bash
pnpm add jose    # JWT 세션 토큰 생성/검증
```

## 상세 스펙

### API 설계

| 엔드포인트                      | 메서드 | 설명             | 인증   |
| ------------------------------- | ------ | ---------------- | ------ |
| `/api/auth/login/[provider]`    | GET    | OAuth 인증 시작  | 불필요 |
| `/api/auth/callback/[provider]` | GET    | OAuth 콜백 처리  | 불필요 |
| `/api/auth/logout`              | POST   | 로그아웃         | 필요   |
| `/api/auth/me`                  | GET    | 현재 사용자 조회 | 필요   |

### 로그인 페이지 UI

```
┌─────────────────────────────────┐
│           nextjs-15-automation-starter-kit 로고              │
├─────────────────────────────────┤
│                                 │
│   [ Google로 로그인 ]           │
│                                 │
│   [ Kakao로 로그인 ]            │
│                                 │
│   (에러 메시지 영역)             │
│                                 │
└─────────────────────────────────┘
```

## 에러 처리

| 에러 상황       | 사용자 메시지              | 처리                       |
| --------------- | -------------------------- | -------------------------- |
| OAuth 인증 거부 | "로그인이 취소되었습니다." | 로그인 페이지로 리다이렉트 |
| 토큰 교환 실패  | "로그인에 실패했습니다."   | 로그인 페이지로 리다이렉트 |
| state 불일치    | "잘못된 요청입니다."       | 로그인 페이지로 리다이렉트 |
| 세션 만료       | "세션이 만료되었습니다."   | 로그인 페이지로 리다이렉트 |

## 성공 기준

### 완료 조건

- [ ] 모든 기능 요구사항(🔴) 구현
- [ ] 타입 체크 통과 (`pnpm build`)
- [ ] 린트 통과 (`pnpm lint`)

### 검증 방법

```bash
pnpm build
pnpm lint

# 수동 테스트
# - Google 로그인 → 성공 → 메인 페이지
# - Kakao 로그인 → 성공 → 메인 페이지
# - 로그아웃 → 로그인 페이지
# - 미인증 상태로 보호 페이지 접근 → 로그인 페이지
```

## 환경변수

```bash
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
KAKAO_CLIENT_ID=
KAKAO_CLIENT_SECRET=
SESSION_SECRET=          # 최소 32자
NEXT_PUBLIC_BASE_URL=    # 콜백 URL용
```

## 제약사항

- 사용자 데이터 저장소는 이 명세서 범위 외 (별도 구현 필요)
- Apple 로그인 미지원
